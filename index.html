<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>การคำนวณเบื้องต้นของระบบดับเพลิงด้วยนํ้า</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --primary-color: #005A9E;
            --secondary-color: #1E88E5;
            --background-color: #f4f7fc;
            --card-background: #ffffff;
            --text-color: #333333;
            --label-color: #555555;
            --border-color: #e0e0e0;
            --success-color: #2E7D32;
            --warning-color: #D32F2F;
            --info-color: #0288D1;
            --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --border-radius: 8px;
        }

        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap');

        body {
            font-family: 'Sarabun', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 900px;
            margin-bottom: 20px; /* Adjusted margin */
        }

        .calculator-container, .guidance-container {
            background-color: var(--card-background);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden;
        }
        
        .guidance-container {
            margin-top: 30px;
        }

        header {
            background-color: var(--primary-color);
            color: white;
            padding: 20px 30px;
            text-align: center;
        }

        header h1 {
            margin: 0;
            font-size: 1.8em;
            font-weight: 700;
        }

        header p {
            margin: 5px 0 0;
            opacity: 0.9;
        }

        main {
            padding: 30px;
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
        }

        @media (min-width: 800px) {
            main {
                grid-template-columns: 1fr 1fr;
                align-items: start;
            }
        }

        fieldset {
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 20px;
            margin: 0;
        }

        legend {
            font-size: 1.2em;
            font-weight: 700;
            color: var(--primary-color);
            padding: 0 10px;
        }
        
        .input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .form-group { margin-bottom: 20px; }
        .form-group:last-child { margin-bottom: 0; }
        .form-group.full-width { grid-column: 1 / -1; }

        label {
            display: flex;
            align-items: center;
            font-weight: 500;
            color: var(--label-color);
            margin-bottom: 8px;
        }

        .label-text {
            display: block;
        }
        .label-eng {
            font-size: 0.8em;
            color: #999;
            font-weight: 400;
        }

        .tooltip-icon {
            position: relative;
            display: inline-block;
            width: 16px;
            height: 16px;
            background-color: #ccc;
            color: white;
            border-radius: 50%;
            text-align: center;
            font-size: 12px;
            line-height: 16px;
            cursor: help;
            margin-left: 8px;
        }

        .tooltip-text {
            visibility: hidden;
            width: 220px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -110px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.85em;
            font-weight: 400;
        }
        
        .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }

        .tooltip-icon:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        .guidance-text { font-size: 0.8em; color: var(--label-color); margin-top: -5px; }
        
        input[type="number"], select {
            width: 100%; padding: 10px; border: 1px solid var(--border-color);
            border-radius: 6px; font-size: 1em; box-sizing: border-box;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        select { background-color: white; }
        input:focus, select:focus {
            outline: none; border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(30, 136, 229, 0.2);
        }
        input[readonly] { background-color: #e9ecef; cursor: not-allowed; font-weight: bold; }

        .result-group { background-color: #f9f9f9; padding: 15px; border-radius: 6px; border: 1px solid var(--border-color); }
        .result-group .label { font-weight: 500; color: var(--label-color); margin-bottom: 8px; }
        .result-value { font-size: 1.3em; font-weight: 700; color: var(--primary-color); display: flex; justify-content: space-between; align-items: baseline; flex-wrap: wrap; }
        .result-value .metric { font-size: 0.8em; font-weight: 400; color: var(--label-color); }
        
        .info-box, .pressure-warning, .pressure-ok, .suggestion-box { 
            margin-top: 10px; padding: 12px; border-radius: 6px; font-size: 0.9em; 
            text-align: center; display: none; overflow-wrap: break-word; line-height: 1.5;
        }
        .info-box { background-color: #E1F5FE; border: 1px solid var(--info-color); color: #01579B; }
        .pressure-warning { background-color: #FFF3E0; border: 1px solid #FFB74D; color: #E65100; }
        .pressure-ok { background-color: #E8F5E9; border: 1px solid var(--success-color); color: var(--success-color); }
        .suggestion-box { background-color: #E3F2FD; border: 1px solid var(--secondary-color); color: var(--primary-color); font-weight: 500; text-align: left; padding-left: 15px; padding-right: 15px;}

        .export-section {
            margin-top: 20px;
            padding: 20px;
            background-color: #f9f9f9;
            border-top: 1px solid var(--border-color);
            text-align: center;
        }
        .export-section button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 1em;
            font-family: 'Sarabun', sans-serif;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            transition: background-color 0.3s;
        }
        .export-section button:hover {
            background-color: var(--secondary-color);
        }
        .export-section button.excel {
            background-color: #1D6F42;
        }
        .export-section button.excel:hover {
            background-color: #2E7D32;
        }

        footer { background-color: #f0f0f0; color: #777; padding: 15px 30px; font-size: 0.85em; text-align: center; }
        
        /* --- NEW/MODIFIED STYLES for Guidance Section --- */
        .guidance-container .content { padding: 20px 30px; }
        .guidance-container h2 {
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 12px; /* Space between icon and text */
            font-size: 1.4em;
        }
        .guidance-container h3 { color: var(--secondary-color); margin-top: 25px; border-left: 3px solid var(--secondary-color); padding-left: 10px;}
        .guidance-container p, .guidance-container ul { line-height: 1.8; color: #444; }
        .guidance-container ul { list-style-type: '✓ '; padding-left: 25px; }
        .guidance-container li { margin-bottom: 12px; padding-left: 5px;}
        .guidance-container strong { color: var(--primary-color); font-weight: 700; }
        .formula { background-color: #eef; font-family: monospace; padding: 10px; border-radius: 6px; text-align: center; margin: 10px 0; }
        
        .print-dynamic-value {
            font-weight: bold;
            background-color: #FFFFCC;
            padding: 2px 6px;
            border-radius: 4px;
            border: 1px solid #E6D87A;
        }

        /* Print Styles */
        @media print {
            body {
                background-color: white; padding: 20px; margin: 0;
                font-size: 10pt;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            .container, footer, .export-section, .tooltip-icon, header p {
                display: none;
            }
            #print-area {
                display: block !important; box-shadow: none; border: none;
            }
            #print-header { text-align: center; margin-bottom: 25px; color: black; }
            #print-header h1 { font-size: 1.5em; margin-bottom: 5px;}
            .print-wrapper { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;}
            .print-fieldset { border: 1px solid #ccc; break-inside: avoid; padding: 15px; }
            .print-fieldset legend { color: black; font-size: 1.2em; font-weight: bold; }
            .print-fieldset .result-value { color: #333; }
            #print-guidance-wrapper { grid-column: 1 / -1; margin-top: 10px; }
            #print-guidance-wrapper h2, #print-guidance-wrapper h3 { color: black; border-color: #999;}
            #print-guidance-wrapper .fas { display: none; } /* Hide icon in print */
            #print-guidance-wrapper strong { color: black; }
            .print-dynamic-value { border: 1px solid #ccc; background-color: #f9f9f9 !important;}
        }
    </style>
</head>
<body>

    <div class="container calculator-container">
        <header>
            <h1>การคำนวณเบื้องต้นของระบบดับเพลิงด้วยนํ้า</h1>
            <p>อ้างอิงมาตรฐาน NFPA, FM และ วสท.</p>
        </header>

        <main>
            <section id="inputs">
                <fieldset>
                    <legend>ข้อมูลสำหรับคำนวณ (Input Data)</legend>
                    <div class="form-group full-width">
                        <label for="hazard_type">
                            <span class="label-text">1. ประเภทพื้นที่อันตราย<span class="label-eng">Hazard Classification</span></span>
                            <div class="tooltip-icon">i<span class="tooltip-text">ระดับความเสี่ยงของพื้นที่ มีผลต่อค่ามาตรฐานที่ใช้ในการคำนวณ</span></div>
                        </label>
                        <select id="hazard_type">
                            <option value="light">Light Hazard (ความเสี่ยงต่ำ)</option>
                            <option value="ordinary1" selected>Ordinary Hazard Group 1 (ความเสี่ยงปานกลาง 1)</option>
                            <option value="ordinary2">Ordinary Hazard Group 2 (ความเสี่ยงปานกลาง 2)</option>
                            <option value="extra1">Extra Hazard Group 1 (ความเสี่ยงสูง 1)</option>
                            <option value="extra2">Extra Hazard Group 2 (ความเสี่ยงสูง 2)</option>
                        </select>
                    </div>
                    <div class="form-group full-width">
                        <label for="density">
                             <span class="label-text">2. ความหนาแน่นของการฉีดน้ำ [gpm/sq.ft]<span class="label-eng">Density (Ds)</span></span>
                             <div class="tooltip-icon">i<span class="tooltip-text">ปริมาณน้ำต่อพื้นที่ที่มาตรฐานกำหนดสำหรับพื้นที่ประเภทต่างๆ</span></div>
                        </label>
                        <input type="number" id="density" step="0.01">
                    </div>
                    <div class="form-group full-width">
                        <label for="area_of_operation">
                             <span class="label-text">3. พื้นที่ปฏิบัติงาน [sq.ft]<span class="label-eng">Area of Operation (Ao)</span></span>
                             <div class="tooltip-icon">i<span class="tooltip-text">พื้นที่สมมติที่ไกลที่สุดจากปั๊ม ซึ่งใช้ในการคำนวณปริมาณน้ำที่ต้องการ</span></div>
                        </label>
                        <input type="number" id="area_of_operation">
                    </div>
                    <div class="input-grid">
                        <div class="form-group">
                            <label for="spacing_s">
                                <span class="label-text">4. ระยะห่างระหว่างหัว (S) [m]<span class="label-eng">Spacing (S)</span></span>
                                <div class="tooltip-icon">i<span class="tooltip-text">ระยะห่างของหัวสปริงเกอร์บนท่อกิ่งเดียวกัน</span></div>
                            </label>
                            <input type="number" id="spacing_s" value="3.7" step="0.1">
                        </div>
                        <div class="form-group">
                            <label for="spacing_l">
                                <span class="label-text">5. ระยะห่างระหว่างกิ่ง (L) [m]<span class="label-eng">Spacing (L)</span></span>
                                <div class="tooltip-icon">i<span class="tooltip-text">ระยะห่างระหว่างท่อกิ่งแต่ละเส้น</span></div>
                            </label>
                            <input type="number" id="spacing_l" value="3.3" step="0.1">
                        </div>
                    </div>
                    <div class="form-group full-width">
                        <label for="coverage_area_display">
                             <span class="label-text">พื้นที่ครอบคลุมต่อหัว<span class="label-eng">Coverage Area (As)</span></span>
                        </label>
                        <input type="text" id="coverage_area_display" readonly>
                        <div id="area_warning" class="info-box"></div>
                    </div>
                     <div class="input-grid">
                        <div class="form-group">
                             <label for="hose_demand">
                                <span class="label-text">6. น้ำสำรองสายฉีด<span class="label-eng">Hose Demand</span></span>
                                <div class="tooltip-icon">i<span class="tooltip-text">ปริมาณน้ำที่ต้องสำรองไว้สำหรับเจ้าหน้าที่ดับเพลิงใช้สายฉีด</span></div>
                            </label>
                            <select id="hose_demand">
                                <option value="100">100 gpm</option>
                                <option value="250">250 gpm</option>
                                <option value="500">500 gpm</option>
                            </select>
                        </div>
                        <div class="form-group">
                             <label for="k_factor">
                                <span class="label-text">7. K-Factor<span class="label-eng">K-Factor</span></span>
                                <div class="tooltip-icon">i<span class="tooltip-text">ค่าคงที่ของหัวสปริงเกอร์ บอกถึงประสิทธิภาพการจ่ายน้ำ</span></div>
                            </label>
                            <select id="k_factor">
                                <option value="5.6">5.6 (Standard)</option>
                                <option value="8.0">8.0 (Large Orifice)</option>
                                <option value="11.2">11.2 (ESFR/Storage)</option>
                            </select>
                        </div>
                    </div>
                     <div class="form-group full-width">
                         <label for="overage_factor">
                            <span class="label-text">8. Overage Factor</span>
                            <div class="tooltip-icon">i<span class="tooltip-text">ตัวคูณเผื่อความปลอดภัยในการคำนวณ (Safety Factor) มักใช้ค่าเป็น 1</span></div>
                        </label>
                        <input type="number" id="overage_factor" value="1.0" step="0.1">
                    </div>
                </fieldset>
            </section>

            <section id="results">
                <fieldset>
                    <legend>ผลการคำนวณ (Calculation Results)</legend>
                    <div class="form-group result-group">
                        <div class="label">ปริมาณน้ำที่ระบบต้องการ<span class="label-eng">Sprinkler System Demand (Qₛ)</span></div>
                        <div class="result-value">
                            <span id="sprinkler_demand_gpm"></span><span class="metric" id="sprinkler_demand_lpm"></span>
                        </div>
                    </div>
                    <div class="form-group result-group">
                        <div class="label">ปริมาณน้ำรวมทั้งระบบ<span class="label-eng">Total Demand (Qₜ)</span></div>
                        <div class="result-value" id="total_demand_result">
                            <span id="total_demand_gpm"></span><span class="metric" id="total_demand_lpm"></span>
                        </div>
                    </div>
                     <div class="form-group result-group">
                        <div class="label">จำนวนหัวสปริงเกอร์ที่ทำงาน<span class="label-eng">Number of Sprinklers (N)</span></div>
                        <div class="result-value">
                            <span id="num_sprinklers"></span><span class="metric" id="num_sprinklers_rounded"></span>
                        </div>
                    </div>
                    <div class="form-group result-group">
                        <div class="label">อัตราการไหลที่หัวสุดท้าย<span class="label-eng">End-Head Flow (q)</span></div>
                        <div class="result-value">
                            <span id="end_head_flow_gpm"></span><span class="metric" id="end_head_flow_lpm"></span>
                        </div>
                    </div>
                    <div class="form-group result-group">
                        <div class="label">แรงดันเริ่มต้นที่หัวสุดท้าย<span class="label-eng">End-Head Start Pressure (P)</span></div>
                        <div class="result-value" id="end_head_pressure_result">
                            <span id="end_head_pressure_psi"></span><span class="metric" id="end_head_pressure_bar"></span>
                        </div>
                        <div id="pressure_warning" class="pressure-warning">
                            <strong>คำเตือน:</strong> แรงดันต่ำกว่า 7 psi (0.5 bar) ซึ่งไม่เป็นไปตามข้อกำหนดขั้นต่ำของ NFPA
                        </div>
                        <div id="pressure_ok" class="pressure-ok">
                            <strong>✓</strong> แรงดันเป็นไปตามข้อกำหนดขั้นต่ำของ NFPA
                        </div>
                        <div id="suggestion_box" class="suggestion-box"></div>
                    </div>
                    <div class="export-section">
                        <button id="exportPdfBtn">📄 ส่งออกเป็น PDF</button>
                    </div>
                </fieldset>
            </section>
        </main>
    </div>
    
    <div class="container guidance-container">
        <div class="content">
            <h2><i class="fa-solid fa-circle-info"></i> ข้อมูลเพิ่มเติมและขั้นตอนถัดไป</h2>
            
            <h3>การนำผลการคำนวณไปใช้งานต่อ</h3>
            <p>ผลลัพธ์จากการคำนวณเบื้องต้นนี้ เป็นข้อมูลสำคัญสำหรับขั้นตอนการออกแบบทางวิศวกรรมขั้นต่อไป โดยเฉพาะการเลือกส่วนประกอบหลักของระบบ:</p>
            <ul>
                <li><strong>การเลือกเครื่องสูบน้ำดับเพลิง (Fire Pump):</strong>
                    ค่า <strong>"ปริมาณน้ำรวมทั้งระบบ (Total Demand)"</strong> ที่คำนวณได้ (<span class="print-dynamic-value" id="guidance-total-demand"></span> GPM) คืออัตราการไหลที่เครื่องสูบน้ำดับเพลิงจะต้องสามารถจ่ายได้เป็นอย่างน้อย ดังนั้น จึงใช้ค่านี้เป็นเกณฑ์หลักในการเลือกรุ่นของ Fire Pump
                </li>
                <li><strong>การกำหนดแรงดันของเครื่องสูบน้ำดับเพลิง:</strong>
                    ค่า <strong>"แรงดันเริ่มต้นที่หัวสุดท้าย (End-Head Pressure)"</strong> (<span class="print-dynamic-value" id="guidance-end-pressure"></span> PSI) คือแรงดันขั้นต่ำที่ต้องการ ณ หัวสปริงเกอร์ที่อยู่ไกลที่สุดในทางชลศาสตร์ การเลือก Fire Pump จะต้องพิจารณาแรงดันนี้ แล้วบวกเพิ่มด้วยค่าแรงดันที่สูญเสียในเส้นท่อ (Friction Loss) และแรงดันจากความสูงของอาคาร (Elevation Head) เพื่อให้ได้แรงดันรวม (Total Head) ที่ Fire Pump ต้องทำได้
                </li>
                <li><strong>การเลือกเครื่องสูบน้ำรักษาแรงดัน (Jockey Pump):</strong>
                    Jockey Pump ไม่ได้ถูกเลือกจากอัตราการไหลนี้ แต่จะถูกเลือกให้มีขนาดเล็กพอที่จะเติมน้ำชดเชยการรั่วซึมเล็กน้อยในระบบ เพื่อรักษาระดับแรงดันให้คงที่ โดยไม่ต้องให้ Fire Pump ขนาดใหญ่ทำงานโดยไม่จำเป็น โดยทั่วไปจะตั้งค่าแรงดันของ Jockey Pump ให้สูงกว่าแรงดันเริ่มทำงาน (Cut-in) ของ Fire Pump เล็กน้อย
                </li>
            </ul>

            <h3>ข้อควรพิจารณาเพิ่มเติม</h3>
            <p>การคำนวณนี้ใช้วิธี Area/Density ซึ่งเป็นการประเมินเบื้องต้นที่สะดวกและรวดเร็ว อย่างไรก็ตาม ในการออกแบบจริงจะต้องมีการ<strong>คำนวณทางชลศาสตร์ (Hydraulic Calculation)</strong> อย่างละเอียดทั้งระบบโดยใช้โปรแกรมคอมพิวเตอร์ตามสมการ Hazen-Williams เพื่อหาค่าความดันสูญเสียในท่อแต่ละเส้นอย่างแม่นยำ และยืนยันว่าทุกหัวสปริงเกอร์ในพื้นที่ปฏิบัติงานจะได้รับน้ำและแรงดันเพียงพอตามมาตรฐาน</p>

            <h3>มาตรฐานอ้างอิงหลัก</h3>
            <ul>
                <li><strong>NFPA 13:</strong> Standard for the Installation of Sprinkler Systems. (มาตรฐานหลักในการติดตั้งระบบหัวกระจายน้ำดับเพลิง)</li>
                <li><strong>NFPA 20:</strong> Standard for the Installation of Stationary Pumps for Fire Protection. (มาตรฐานการติดตั้งเครื่องสูบน้ำดับเพลิง)</li>
                <li><strong>มาตรฐาน วสท.:</strong> มาตรฐานการป้องกันอัคคีภัย โดยวิศวกรรมสถานแห่งประเทศไทย ในพระบรมราชูปถัมภ์ ซึ่งอ้างอิงและปรับใช้ให้เข้ากับบริบทของประเทศไทย</li>
                <li><strong>FM Global Data Sheets (e.g., FMDS 2-0):</strong> มาตรฐานจากสถาบันประกันภัยซึ่งมักมีข้อกำหนดที่เข้มงวดกว่าสำหรับอาคารหรือโรงงานที่มีความเสี่ยงสูง</li>
            </ul>
        </div>
    </div>
    
    <div id="print-area" style="display: none;">
        <div id="print-header">
            <h1>สรุปผลการคำนวณเบื้องต้นระบบดับเพลิงด้วยน้ำ</h1>
            <p id="print-date"></p>
        </div>
        <div class="print-wrapper">
             <div id="print-inputs-wrapper"></div>
             <div id="print-results-wrapper"></div>
        </div>
        <div id="print-guidance-wrapper"></div>
    </div>

    <footer>
        <p>Disclaimer: This calculator provides preliminary estimates for educational and informational purposes only. It is not a substitute for professional engineering design. Always consult a qualified fire protection engineer and comply with all applicable codes and standards (NFPA, EIT, local regulations).</p>
    </footer>

    <script>
        // --- CONFIGURATION ---
        const M_TO_FT = 3.28084;
        const GPM_TO_LPM = 3.78541; // Corrected to standard conversion
        const PSI_TO_BAR = 0.0689476;
        const MIN_PRESSURE_PSI = 7.0;

        const HAZARD_CONFIG = {
            light: { name: 'Light Hazard', density: 0.10, area: 1500, hose: 100, maxSpacing: 4.6, maxArea: 20.9 },
            ordinary1: { name: 'Ordinary Hazard Gr.1', density: 0.15, area: 1500, hose: 250, maxSpacing: 4.6, maxArea: 12.1 },
            ordinary2: { name: 'Ordinary Hazard Gr.2', density: 0.20, area: 1500, hose: 250, maxSpacing: 4.6, maxArea: 12.1 },
            extra1: { name: 'Extra Hazard Gr.1', density: 0.30, area: 2500, hose: 500, maxSpacing: 3.7, maxArea: 9.3 },
            extra2: { name: 'Extra Hazard Gr.2', density: 0.40, area: 2500, hose: 500, maxSpacing: 3.7, maxArea: 9.3 },
        };

        // --- DOM ELEMENTS ---
        const elements = {
            hazardType: document.getElementById('hazard_type'),
            density: document.getElementById('density'),
            areaOfOperation: document.getElementById('area_of_operation'),
            spacingS: document.getElementById('spacing_s'),
            spacingL: document.getElementById('spacing_l'),
            coverageAreaDisplay: document.getElementById('coverage_area_display'),
            areaWarning: document.getElementById('area_warning'),
            hoseDemand: document.getElementById('hose_demand'),
            kFactor: document.getElementById('k_factor'),
            overageFactor: document.getElementById('overage_factor'),
            sprinklerDemandGpm: document.getElementById('sprinkler_demand_gpm'),
            sprinklerDemandLpm: document.getElementById('sprinkler_demand_lpm'),
            totalDemandGpm: document.getElementById('total_demand_gpm'),
            totalDemandLpm: document.getElementById('total_demand_lpm'),
            numSprinklers: document.getElementById('num_sprinklers'),
            numSprinklersRounded: document.getElementById('num_sprinklers_rounded'),
            endHeadFlowGpm: document.getElementById('end_head_flow_gpm'),
            endHeadFlowLpm: document.getElementById('end_head_flow_lpm'),
            endHeadPressurePsi: document.getElementById('end_head_pressure_psi'),
            endHeadPressureBar: document.getElementById('end_head_pressure_bar'),
            pressureWarning: document.getElementById('pressure_warning'),
            pressureOk: document.getElementById('pressure_ok'),
            suggestionBox: document.getElementById('suggestion_box'),
            exportPdfBtn: document.getElementById('exportPdfBtn'),
            guidanceTotalDemand: document.getElementById('guidance-total-demand'),
            guidanceEndPressure: document.getElementById('guidance-end-pressure'),
        };

        // --- FUNCTIONS ---
        function updateHazardDefaults() {
            const hazard = HAZARD_CONFIG[elements.hazardType.value];
            if (hazard) {
                elements.density.value = hazard.density;
                elements.areaOfOperation.value = hazard.area;
                elements.hoseDemand.value = hazard.hose;
                checkSpacingAndCoverage(true);
            }
        }

        function checkSpacingAndCoverage(isHazardChange = false) {
            const hazard = HAZARD_CONFIG[elements.hazardType.value];
            const s_m = parseFloat(elements.spacingS.value) || 0;
            const l_m = parseFloat(elements.spacingL.value) || 0;
            const as_m2 = s_m * l_m;
            const as_sqft = as_m2 * M_TO_FT * M_TO_FT;

            elements.coverageAreaDisplay.value = `${as_sqft.toFixed(2)} sq.ft (${as_m2.toFixed(2)} m²)`;

            const maxArea_m2 = hazard.maxArea;
            const maxSpacing_m = hazard.maxSpacing;

            let warningText = '';
            if (s_m > maxSpacing_m || l_m > maxSpacing_m) {
                warningText += `ระยะห่าง S หรือ L เกินค่าสูงสุดที่กำหนด (${maxSpacing_m} m). `;
            }
            if (as_m2 > maxArea_m2) {
                warningText += `พื้นที่ครอบคลุมต่อหัว (${as_m2.toFixed(2)} m²) เกินค่าสูงสุดที่กำหนด (${maxArea_m2} m²).`;
            }

            elements.areaWarning.style.display = warningText ? 'block' : 'none';
            elements.areaWarning.textContent = warningText;

            if (isHazardChange) {
                // Do not recalculate on hazard change, just update defaults
                return;
            }
            calculateAndDisplay();
        }

        function calculateAndDisplay() {
            // 1. Get Inputs
            const density = parseFloat(elements.density.value) || 0;
            const areaOp = parseFloat(elements.areaOfOperation.value) || 0;
            const s_m = parseFloat(elements.spacingS.value) || 0;
            const l_m = parseFloat(elements.spacingL.value) || 0;
            const hoseDemand = parseFloat(elements.hoseDemand.value) || 0;
            const kFactor = parseFloat(elements.kFactor.value) || 5.6;
            const overage = parseFloat(elements.overageFactor.value) || 1.0;
            const coverage_sqft = (s_m * l_m) * M_TO_FT * M_TO_FT;

            // 2. Calculations
            const sprinklerDemand = density * areaOp * overage;
            const totalDemand = sprinklerDemand + hoseDemand;
            const numSprinklers = coverage_sqft > 0 ? areaOp / coverage_sqft : 0;
            const numSprinklersRounded = Math.ceil(numSprinklers);
            const endHeadFlow = density * coverage_sqft;
            const endHeadPressure = kFactor > 0 ? Math.pow(endHeadFlow / kFactor, 2) : 0;
            
            const results = {
                sprinkler_demand_gpm: sprinklerDemand,
                total_demand_gpm: totalDemand,
                num_sprinklers: numSprinklers,
                num_sprinklers_rounded: numSprinklersRounded,
                end_head_flow_gpm: endHeadFlow,
                end_head_pressure_psi: endHeadPressure
            };

            // 3. Display Results
            displayResults(results);

            // 4. Update Guidance Text
            updateGuidanceText(results);
            
            // 5. Update content for printing
            updatePrintContent(results);
        }

        function displayResults(r) {
            elements.sprinklerDemandGpm.textContent = `${r.sprinkler_demand_gpm.toFixed(0)} GPM`;
            elements.sprinklerDemandLpm.textContent = `(${(r.sprinkler_demand_gpm * GPM_TO_LPM).toFixed(0)} LPM)`;
            elements.totalDemandGpm.textContent = `${r.total_demand_gpm.toFixed(0)} GPM`;
            elements.totalDemandLpm.textContent = `(${(r.total_demand_gpm * GPM_TO_LPM).toFixed(0)} LPM)`;
            elements.numSprinklers.textContent = `${r.num_sprinklers.toFixed(2)}`;
            elements.numSprinklersRounded.textContent = `(ต้องใช้ ${r.num_sprinklers_rounded} หัว)`;
            elements.endHeadFlowGpm.textContent = `${r.end_head_flow_gpm.toFixed(2)} GPM`;
            elements.endHeadFlowLpm.textContent = `(${(r.end_head_flow_gpm * GPM_TO_LPM).toFixed(2)} LPM)`;
            elements.endHeadPressurePsi.textContent = `${r.end_head_pressure_psi.toFixed(2)} psi`;
            elements.endHeadPressureBar.textContent = `(${(r.end_head_pressure_psi * PSI_TO_BAR).toFixed(2)} bar)`;

            // Pressure Check
            elements.suggestionBox.style.display = 'none';
            if (r.end_head_pressure_psi < MIN_PRESSURE_PSI) {
                elements.pressureWarning.style.display = 'block';
                elements.pressureOk.style.display = 'none';
                
                let suggestions = '<strong>คำแนะนำ:</strong><ul>';
                const requiredK = r.end_head_flow_gpm / Math.sqrt(MIN_PRESSURE_PSI);
                suggestions += `<li>หากต้องการแรงดันที่ ${MIN_PRESSURE_PSI} psi จะต้องมีอัตราการไหลที่หัวอย่างน้อย ${r.end_head_flow_gpm.toFixed(2)} GPM.</li>`;
                suggestions += `<li>ลองพิจารณาเปลี่ยน K-Factor ให้มีค่ามากขึ้น (เช่น ${findNextK(kFactor)}) ซึ่งจะช่วยลดแรงดันที่ต้องการ</li>`;
                suggestions += `<li>หรือลดระยะห่างระหว่างหัว (S/L) เพื่อลดพื้นที่ครอบคลุม (As) ซึ่งจะลดอัตราการไหลที่หัวสุดท้าย (q) และลดแรงดันที่ต้องการลง</li></ul>`;

                elements.suggestionBox.innerHTML = suggestions;
                elements.suggestionBox.style.display = 'block';

            } else {
                elements.pressureWarning.style.display = 'none';
                elements.pressureOk.style.display = 'block';
            }
        }
        
        function updateGuidanceText(r) {
            elements.guidanceTotalDemand.textContent = r.total_demand_gpm.toFixed(0);
            elements.guidanceEndPressure.textContent = r.end_head_pressure_psi.toFixed(2);
        }

        function findNextK(currentK) {
            const kValues = [5.6, 8.0, 11.2];
            const currentIndex = kValues.indexOf(parseFloat(currentK));
            if (currentIndex > -1 && currentIndex < kValues.length - 1) {
                return kValues[currentIndex + 1];
            }
            return '11.2+';
        }

        function updatePrintContent(results) {
             const createPrintField = (label, eng, value, unit, subValue, subUnit) => `
                <div class="result-group">
                    <div class="label">${label}<span class="label-eng">${eng}</span></div>
                    <div class="result-value">
                        <span>${value} ${unit}</span>
                        ${subValue ? `<span class="metric">(${subValue} ${subUnit})</span>` : ''}
                    </div>
                </div>`;

            // Inputs
            const inputsWrapper = document.getElementById('print-inputs-wrapper');
            const hazard = HAZARD_CONFIG[elements.hazardType.value];
            inputsWrapper.innerHTML = `
                <fieldset class="print-fieldset">
                    <legend>ข้อมูลนำเข้า</legend>
                    ${createPrintField('ประเภทพื้นที่', 'Hazard', hazard.name, '')}
                    ${createPrintField('ความหนาแน่น', 'Density', elements.density.value, 'gpm/sq.ft')}
                    ${createPrintField('พื้นที่ปฏิบัติงาน', 'Area of Op.', elements.areaOfOperation.value, 'sq.ft')}
                    ${createPrintField('ระยะห่าง (S x L)', 'Spacing', `${elements.spacingS.value}m x ${elements.spacingL.value}m`, '')}
                    ${createPrintField('พื้นที่ต่อหัว', 'Area/Sprinkler', elements.coverageAreaDisplay.value, '')}
                    ${createPrintField('น้ำสำรองสายฉีด', 'Hose Demand', elements.hoseDemand.value, 'gpm')}
                    ${createPrintField('K-Factor', 'K-Factor', elements.kFactor.value, '')}
                </fieldset>`;

            // Results
            const resultsWrapper = document.getElementById('print-results-wrapper');
            resultsWrapper.innerHTML = `
                <fieldset class="print-fieldset">
                    <legend>ผลการคำนวณ</legend>
                    ${createPrintField('ปริมาณน้ำระบบ', 'Sprinkler Demand', results.sprinkler_demand_gpm.toFixed(0), 'GPM', (results.sprinkler_demand_gpm * GPM_TO_LPM).toFixed(0), 'LPM')}
                    ${createPrintField('ปริมาณน้ำรวม', 'Total Demand', results.total_demand_gpm.toFixed(0), 'GPM', (results.total_demand_gpm * GPM_TO_LPM).toFixed(0), 'LPM')}
                    ${createPrintField('จำนวนหัวทำงาน', '# Sprinklers', results.num_sprinklers.toFixed(2), 'หัว', `(ใช้ ${results.num_sprinklers_rounded})`, '')}
                    ${createPrintField('Flow หัวสุดท้าย', 'End-Head Flow', results.end_head_flow_gpm.toFixed(2), 'GPM', (results.end_head_flow_gpm * GPM_TO_LPM).toFixed(2), 'LPM')}
                    ${createPrintField('Pressure หัวสุดท้าย', 'End-Head Pressure', results.end_head_pressure_psi.toFixed(2), 'psi', (results.end_head_pressure_psi * PSI_TO_BAR).toFixed(2), 'bar')}
                </fieldset>`;
            
             // Guidance section
            const guidanceContent = document.querySelector('.guidance-container .content').cloneNode(true);
            const guidanceWrapper = document.getElementById('print-guidance-wrapper');
            guidanceWrapper.innerHTML = ''; // Clear previous
            guidanceWrapper.appendChild(guidanceContent);

            // Update the dynamic values within the cloned print content
            const printGuidanceTotalDemand = guidanceWrapper.querySelector('#guidance-total-demand');
            const printGuidanceEndPressure = guidanceWrapper.querySelector('#guidance-end-pressure');
            
            if (printGuidanceTotalDemand) printGuidanceTotalDemand.textContent = results.total_demand_gpm.toFixed(0);
            if (printGuidanceEndPressure) printGuidanceEndPressure.textContent = results.end_head_pressure_psi.toFixed(2);
            
            document.getElementById('print-date').textContent = `วันที่คำนวณ: ${new Date().toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric'})}`;
        }
        
        // --- EVENT LISTENERS ---
        elements.hazardType.addEventListener('change', () => {
            updateHazardDefaults();
            calculateAndDisplay();
        });
        
        const inputsToRecalculate = [
            elements.density, elements.areaOfOperation, elements.spacingS,
            elements.spacingL, elements.hoseDemand, elements.kFactor, elements.overageFactor
        ];

        inputsToRecalculate.forEach(input => {
            input.addEventListener('input', () => {
                if (input === elements.spacingS || input === elements.spacingL) {
                    checkSpacingAndCoverage();
                } else {
                    calculateAndDisplay();
                }
            });
        });

        elements.exportPdfBtn.addEventListener('click', () => {
            updatePrintContent(calculateAndDisplay()); // Ensure content is fresh before printing
            window.print();
        });

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            updateHazardDefaults();
            calculateAndDisplay();
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>การคำนวณเบื้องต้นของระบบดับเพลิงด้วยนํ้า</title>
    <style>
        :root {
            --primary-color: #005A9E;
            --secondary-color: #1E88E5;
            --background-color: #f4f7fc;
            --card-background: #ffffff;
            --text-color: #333333;
            --label-color: #555555;
            --border-color: #e0e0e0;
            --success-color: #2E7D32;
            --warning-color: #D32F2F;
            --info-color: #0288D1;
            --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --border-radius: 8px;
        }

        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap');

        body {
            font-family: 'Sarabun', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 900px;
            margin-bottom: 30px;
        }

        .calculator-container, .guidance-container {
            background-color: var(--card-background);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden;
        }

        header {
            background-color: var(--primary-color);
            color: white;
            padding: 20px 30px;
            text-align: center;
        }

        header h1 {
            margin: 0;
            font-size: 1.8em;
            font-weight: 700;
        }

        header p {
            margin: 5px 0 0;
            opacity: 0.9;
        }

        main {
            padding: 30px;
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
        }

        @media (min-width: 800px) {
            main {
                grid-template-columns: 1fr 1fr;
                align-items: start;
            }
        }

        fieldset {
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 20px;
            margin: 0;
        }

        legend {
            font-size: 1.2em;
            font-weight: 700;
            color: var(--primary-color);
            padding: 0 10px;
        }
        
        .input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .form-group { margin-bottom: 20px; }
        .form-group:last-child { margin-bottom: 0; }
        .form-group.full-width { grid-column: 1 / -1; }

        label {
            display: flex;
            align-items: center;
            font-weight: 500;
            color: var(--label-color);
            margin-bottom: 8px;
        }

        .label-text {
            display: block;
        }
        .label-eng {
            font-size: 0.8em;
            color: #999;
            font-weight: 400;
        }

        .tooltip-icon {
            position: relative;
            display: inline-block;
            width: 16px;
            height: 16px;
            background-color: #ccc;
            color: white;
            border-radius: 50%;
            text-align: center;
            font-size: 12px;
            line-height: 16px;
            cursor: help;
            margin-left: 8px;
        }

        .tooltip-text {
            visibility: hidden;
            width: 220px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -110px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.85em;
            font-weight: 400;
        }
        
        .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }

        .tooltip-icon:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        .guidance-text { font-size: 0.8em; color: var(--label-color); margin-top: 5px; }
        
        input[type="number"], select {
            width: 100%; padding: 10px; border: 1px solid var(--border-color);
            border-radius: 6px; font-size: 1em; box-sizing: border-box;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        select { background-color: white; }
        input:focus, select:focus {
            outline: none; border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(30, 136, 229, 0.2);
        }
        input[readonly] { background-color: #e9ecef; cursor: not-allowed; font-weight: bold; }

        .result-group { background-color: #f9f9f9; padding: 15px; border-radius: 6px; border: 1px solid var(--border-color); }
        .result-group .label { font-weight: 500; color: var(--label-color); margin-bottom: 8px; }
        .result-value { font-size: 1.3em; font-weight: 700; color: var(--primary-color); display: flex; justify-content: space-between; align-items: baseline; flex-wrap: wrap; }
        .result-value .metric { font-size: 0.8em; font-weight: 400; color: var(--label-color); }
        
        .info-box, .pressure-warning, .pressure-ok, .suggestion-box { 
            margin-top: 10px; padding: 12px; border-radius: 6px; font-size: 0.9em; 
            text-align: center; display: none; overflow-wrap: break-word; line-height: 1.5;
        }
        .info-box { background-color: #E1F5FE; border: 1px solid var(--info-color); color: #01579B; }
        .pressure-warning { background-color: #FFF3E0; border: 1px solid #FFB74D; color: #E65100; }
        .pressure-ok { background-color: #E8F5E9; border: 1px solid var(--success-color); color: var(--success-color); }
        .suggestion-box { background-color: #E3F2FD; border: 1px solid var(--secondary-color); color: var(--primary-color); font-weight: 500; text-align: left; padding-left: 15px; padding-right: 15px;}

        .export-section {
            margin-top: 20px;
            padding: 20px;
            background-color: #f9f9f9;
            border-top: 1px solid var(--border-color);
            text-align: center;
        }
        .export-section button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 1em;
            font-family: 'Sarabun', sans-serif;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            transition: background-color 0.3s;
        }
        .export-section button.pdf:hover {
            background-color: var(--secondary-color);
        }
        .export-section button.excel {
            background-color: #1D6F42;
        }
        .export-section button.excel:hover {
            background-color: #2E7D32;
        }

        footer { background-color: #f0f0f0; color: #777; padding: 15px 30px; font-size: 0.85em; text-align: center; }
        
        .guidance-container .content { padding: 30px; }
        .guidance-container h2 { font-size: 1.5em; color: var(--primary-color); border-bottom: 2px solid var(--primary-color); padding-bottom: 10px; margin-top:0; }
        .guidance-container h3, .guidance-container h4 { font-size: 1.2em; color: var(--secondary-color); margin-top: 25px; margin-bottom: 15px;}
        .guidance-container h4 { font-size: 1.1em; color: var(--primary-color); margin-top: 20px; }
        .guidance-container p, .guidance-container ul { line-height: 1.8; }
        .guidance-container ul { list-style-type: '✓ '; padding-left: 25px; }
        .guidance-container li { margin-bottom: 10px; }
        .guidance-container .sub-list { list-style-type: '• '; margin-top: 8px; }
        .formula { background-color: #eef; font-family: monospace; padding: 15px; border-radius: 6px; border: 1px solid #dbe3f8; text-align: center; margin: 15px 0; font-size: 1.1em; overflow-x: auto; }
        
        /* Print Styles */
        @media print {
            body {
                background-color: white; padding: 0; margin: 0;
                font-size: 10pt;
                 -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            .container, footer, .export-section, .tooltip-icon, header {
                display: none !important;
            }
            #print-area {
                display: block !important; box-shadow: none !important; border: none !important;
                width: 100%; max-width: 100%;
            }
            #print-header {
                text-align: center; margin-bottom: 25px;
                color: black;
            }
            #print-header h1 { font-size: 18pt; margin-bottom: 5px;}
            #print-header p { font-size: 11pt; margin-top: 0; }

            .print-section {
                 page-break-inside: avoid;
                 margin-bottom: 20px;
            }
            .print-fieldset {
                border: 1px solid #ccc !important; break-inside: avoid; margin-bottom: 20px; padding: 15px;
            }
            .print-fieldset legend { color: black !important; font-size: 1.3em; font-weight: bold; }
            .print-fieldset .result-value { color: #333 !important; }
            #print-guidance-wrapper h2, #print-guidance-wrapper h3, #print-guidance-wrapper h4 { color: black !important; border-color: #ccc !important; }
            #print-guidance-wrapper .formula { border: 1px solid #ccc !important; background-color: #f9f9f9 !important; }
        }
    </style>
</head>
<body>

    <div class="container calculator-container">
        <header>
            <h1>การคำนวณเบื้องต้นของระบบดับเพลิงด้วยนํ้า</h1>
            <p>อ้างอิงมาตรฐาน NFPA, FM และ วสท.</p>
        </header>

        <main>
            <section id="inputs">
                <fieldset>
                    <legend>ข้อมูลสำหรับคำนวณ (Input Data)</legend>
                    <div class="form-group full-width">
                        <label for="hazard_type">
                            <span class="label-text">1. ประเภทพื้นที่อันตราย<span class="label-eng">Hazard Classification</span></span>
                            <div class="tooltip-icon">i<span class="tooltip-text">ระดับความเสี่ยงของพื้นที่ มีผลต่อค่ามาตรฐานที่ใช้ในการคำนวณ</span></div>
                        </label>
                        <select id="hazard_type">
                            <option value="light">Light Hazard (ความเสี่ยงต่ำ)</option>
                            <option value="ordinary1">Ordinary Hazard Group 1 (ความเสี่ยงปานกลาง 1)</option>
                            <option value="ordinary2">Ordinary Hazard Group 2 (ความเสี่ยงปานกลาง 2)</option>
                            <option value="extra1">Extra Hazard Group 1 (ความเสี่ยงสูง 1)</option>
                            <option value="extra2">Extra Hazard Group 2 (ความเสี่ยงสูง 2)</option>
                        </select>
                    </div>
                    <div class="form-group full-width">
                        <label for="density">
                             <span class="label-text">2. ความหนาแน่นของการฉีดน้ำ [gpm/sq.ft]<span class="label-eng">Density (Ds)</span></span>
                             <div class="tooltip-icon">i<span class="tooltip-text">ปริมาณน้ำต่อพื้นที่ที่มาตรฐานกำหนดสำหรับพื้นที่ประเภทต่างๆ</span></div>
                        </label>
                        <input type="number" id="density" step="0.01">
                    </div>
                    <div class="form-group full-width">
                        <label for="area_of_operation">
                             <span class="label-text">3. พื้นที่ปฏิบัติงาน [sq.ft]<span class="label-eng">Area of Operation (Ao)</span></span>
                             <div class="tooltip-icon">i<span class="tooltip-text">พื้นที่สมมติที่ไกลที่สุดจากปั๊ม ซึ่งใช้ในการคำนวณปริมาณน้ำที่ต้องการ</span></div>
                        </label>
                        <input type="number" id="area_of_operation">
                    </div>
                    <div class="input-grid">
                        <div class="form-group">
                            <label for="spacing_s">
                                <span class="label-text">4. ระยะห่างระหว่างหัว (S) [m]<span class="label-eng">Spacing (S)</span></span>
                                <div class="tooltip-icon">i<span class="tooltip-text">ระยะห่างของหัวสปริงเกอร์บนท่อกิ่งเดียวกัน (หน่วย: เมตร)</span></div>
                            </label>
                            <input type="number" id="spacing_s" value="3.0" step="0.1">
                            <p id="spacing_s_guidance" class="guidance-text"></p>
                        </div>
                        <div class="form-group">
                            <label for="spacing_l">
                                <span class="label-text">5. ระยะห่างระหว่างกิ่ง (L) [m]<span class="label-eng">Spacing (L)</span></span>
                                <div class="tooltip-icon">i<span class="tooltip-text">ระยะห่างระหว่างท่อกิ่งแต่ละเส้น (หน่วย: เมตร)</span></div>
                            </label>
                            <input type="number" id="spacing_l" value="4.0" step="0.1">
                             <p id="spacing_l_guidance" class="guidance-text"></p>
                        </div>
                    </div>
                    <div class="form-group full-width">
                        <label for="coverage_area_display">
                             <span class="label-text">พื้นที่ครอบคลุมต่อหัว<span class="label-eng">Coverage Area (As)</span></span>
                        </label>
                        <input type="text" id="coverage_area_display" readonly>
                        <div id="area_warning" class="info-box"></div>
                    </div>
                     <div class="input-grid">
                        <div class="form-group">
                             <label for="hose_demand">
                                <span class="label-text">6. น้ำสำรองสายฉีด<span class="label-eng">Hose Demand</span></span>
                                <div class="tooltip-icon">i<span class="tooltip-text">ปริมาณน้ำที่ต้องสำรองไว้สำหรับเจ้าหน้าที่ดับเพลิงใช้สายฉีด</span></div>
                            </label>
                            <select id="hose_demand">
                                <option value="100">100 gpm (Light Hazard)</option>
                                <option value="250">250 gpm (Ordinary Hazard)</option>
                                <option value="500">500 gpm (Extra Hazard)</option>
                            </select>
                        </div>
                        <div class="form-group">
                             <label for="k_factor">
                                <span class="label-text">7. K-Factor<span class="label-eng">K-Factor</span></span>
                                <div class="tooltip-icon">i<span class="tooltip-text">ค่าคงที่ของหัวสปริงเกอร์ บอกถึงประสิทธิภาพการจ่ายน้ำ</span></div>
                            </label>
                            <select id="k_factor">
                                <option value="5.6">5.6 (Standard)</option>
                                <option value="8.0">8.0 (Large Orifice)</option>
                                <option value="11.2">11.2 (ESFR/Storage)</option>
                            </select>
                        </div>
                    </div>
                     <div class="form-group full-width">
                         <label for="overage_factor">
                            <span class="label-text">8. Overage Factor</span>
                            <div class="tooltip-icon">i<span class="tooltip-text">ตัวคูณเผื่อความปลอดภัยในการคำนวณ มักใช้ค่าเป็น 1</span></div>
                        </label>
                        <input type="number" id="overage_factor" value="1.0" step="0.1">
                    </div>
                </fieldset>
            </section>

            <section id="results">
                <fieldset>
                    <legend>ผลการคำนวณ (Calculation Results)</legend>
                    <div class="form-group result-group">
                        <div class="label">ปริมาณน้ำที่ระบบต้องการ<span class="label-eng">Sprinkler System Demand</span></div>
                        <div class="result-value">
                            <span id="sprinkler_demand_gpm"></span><span class="metric" id="sprinkler_demand_lpm"></span>
                        </div>
                    </div>
                    <div class="form-group result-group">
                        <div class="label">ปริมาณน้ำรวมทั้งระบบ<span class="label-eng">Total Demand</span></div>
                        <div class="result-value" id="total_demand_result">
                            <span id="total_demand_gpm"></span><span class="metric" id="total_demand_lpm"></span>
                        </div>
                    </div>
                     <div class="form-group result-group">
                        <div class="label">จำนวนหัวสปริงเกอร์ที่ทำงาน<span class="label-eng">Number of Sprinklers</span></div>
                        <div class="result-value">
                            <span id="num_sprinklers"></span><span class="metric" id="num_sprinklers_rounded"></span>
                        </div>
                    </div>
                    <div class="form-group result-group">
                        <div class="label">อัตราการไหลที่หัวสุดท้าย<span class="label-eng">End-Head Flow</span></div>
                        <div class="result-value">
                            <span id="end_head_flow_gpm"></span><span class="metric" id="end_head_flow_lpm"></span>
                        </div>
                    </div>
                    <div class="form-group result-group">
                        <div class="label">แรงดันเริ่มต้นที่หัวสุดท้าย<span class="label-eng">End-Head Start Pressure</span></div>
                        <div class="result-value" id="end_head_pressure_result">
                            <span id="end_head_pressure_psi"></span><span class="metric" id="end_head_pressure_bar"></span>
                        </div>
                        <div id="pressure_warning" class="pressure-warning">
                            <strong>คำเตือน:</strong> แรงดันต่ำกว่า 7 psi (0.5 bar) ซึ่งไม่เป็นไปตามข้อกำหนดขั้นต่ำของ NFPA
                        </div>
                        <div id="pressure_ok" class="pressure-ok">
                            <strong>✓</strong> แรงดันเป็นไปตามข้อกำหนดขั้นต่ำของ NFPA
                        </div>
                        <div id="suggestion_box" class="suggestion-box"></div>
                    </div>
                    <div class="export-section">
                        <button id="exportPdfBtn" class="pdf">📄 ส่งออกเป็น PDF</button>
                        <button id="exportExcelBtn" class="excel">📊 ส่งออกเป็น Excel (.csv)</button>
                    </div>
                </fieldset>
            </section>
        </main>
    </div>

    <div class="container guidance-container" id="guidance-section">
        <div class="content">
            <h2>ข้อมูลอ้างอิงและการนำไปใช้งาน (Reference & Application)</h2>
            
            <h3>ที่มาของค่าต่างๆ ตามมาตรฐาน</h3>
            <p>การคำนวณนี้อ้างอิงหลักการจากมาตรฐานสากล เพื่อให้ได้ผลลัพธ์ที่เป็นพื้นฐานสำหรับการออกแบบในขั้นต่อไป:</p>
            <ul>
                <li><strong>ความหนาแน่น (Density) และพื้นที่ปฏิบัติงาน (Area of Operation):</strong> ค่าพื้นฐานเหล่านี้มาจากกราฟ <strong>Density/Area Curves ในมาตรฐาน NFPA 13</strong> ซึ่งเป็นหัวใจของการออกแบบระบบสปริงเกอร์ โดยจะแปรผันตามประเภทความเสี่ยงของพื้นที่ (Hazard Classification)</li>
                <li><strong>น้ำสำรองสายฉีด (Hose Demand):</strong> ปริมาณน้ำสำหรับสายฉีดดับเพลิง (100, 250, หรือ 500 GPM) ถูกกำหนดไว้ในตารางของ <strong>NFPA 13</strong> ซึ่งเป็นข้อบังคับที่ต้องนำมาบวกเพิ่มเข้าไปในความต้องการน้ำของระบบสปริงเกอร์</li>
                 <li><strong>แรงดันเริ่มต้นขั้นต่ำ (Minimum Start Pressure):</strong> มาตรฐาน <strong>NFPA 13</strong> กำหนดว่าแรงดันที่หัวสปริงเกอร์ (ไม่ว่าจะเป็นหัวฉีดมาตรฐานหรือหัวเฉพาะทาง) จะต้องไม่น้อยกว่า <strong>7 psi (0.5 bar)</strong> เพื่อให้รูปแบบการกระจายน้ำเป็นไปตามที่ออกแบบไว้</li>
                <li><strong>ผลรวมความต้องการน้ำ (Total Demand):</strong> คือผลรวมของน้ำสำหรับระบบสปริงเกอร์ (Sprinkler Demand) และน้ำสำหรับสายฉีด (Hose Demand) ค่านี้คือจุดเริ่มต้นสำคัญที่จะนำไปใช้เลือกขนาดปั๊มน้ำดับเพลิงตามมาตรฐาน <strong>NFPA 20</strong></li>
                 <li><strong>มาตรฐาน FM Global:</strong> สำหรับโครงการบางประเภท โดยเฉพาะคลังสินค้าที่มีความเสี่ยงสูง อาจต้องพิจารณาข้อกำหนดจาก <strong>FM Global Data Sheets (เช่น FM 2-0)</strong> ประกอบด้วย ซึ่งอาจมีข้อกำหนดด้าน Density/Area ที่เข้มงวดกว่า NFPA</li>
            </ul>

            <h3>การนำผลลัพธ์ไปใช้งานต่อ</h3>
            <p>ผลการคำนวณเบื้องต้นนี้เป็นข้อมูลสำคัญสำหรับวิศวกรในการตัดสินใจออกแบบองค์ประกอบหลักของระบบดับเพลิงดังนี้:</p>

            <h4>1. การเลือกปั๊มน้ำดับเพลิง (Fire Pump & Jockey Pump Selection)</h4>
            <p><strong>- Fire Pump:</strong></p>
            <ul>
                <li><strong>อัตราการไหล (Rated Flow):</strong> ใช้ค่า <strong id="pump-demand-gpm"></strong> GPM (Total Demand) ที่คำนวณได้ เพื่อเลือกรุ่นของ Fire Pump ที่มีอัตราการไหลมาตรฐานไม่ต่ำกว่าค่านี้ (เช่น หากคำนวณได้ 650 GPM ควรเลือกใช้ปั๊มขนาด 750 GPM)</li>
                <li><strong>แรงดัน (Rated Pressure):</strong> ค่า <strong id="pump-pressure-psi"></strong> psi (End-Head Start Pressure) เป็นเพียงแรงดันขั้นต่ำที่ปลายท่อ ในการออกแบบจริงจะต้องคำนวณหาความดันสูญเสียในท่อ (Friction Loss) และแรงดันจากความสูงของอาคาร (Elevation Head) เพื่อหาแรงดันรวมที่ Fire Pump ต้องทำได้ ณ อัตราการไหลที่กำหนด ซึ่งทั้งหมดนี้ต้องเป็นไปตามมาตรฐาน <strong>NFPA 20</strong></li>
            </ul>
             <p><strong>- Jockey Pump:</strong></p>
             <ul>
                 <li>ปั๊มรักษาแรงดัน (Jockey Pump) จะถูกเลือกให้มีอัตราการไหลน้อย (ปกติประมาณ 1% ของ Fire Pump) แต่ต้องทำแรงดันได้สูงกว่าเล็กน้อย เพื่อรักษาระดับแรงดันในเส้นท่อและป้องกันไม่ให้ Fire Pump เริ่มทำงานโดยไม่จำเป็น</li>
             </ul>

            <h4>2. การคำนวณขนาดถังเก็บน้ำสำรอง (Water Tank Sizing)</h4>
            <p>ปริมาณน้ำสำรองที่ต้องกักเก็บ จะขึ้นอยู่กับ Total Demand และระยะเวลาการจ่ายน้ำตามที่มาตรฐานกำหนด</p>
            <div class="formula">
                ขนาดถัง (ลิตร) = ปริมาณน้ำรวม (LPM) &times; ระยะเวลาจ่ายน้ำ (นาที)
            </div>
             <ul>
                 <li><strong>ระยะเวลาจ่ายน้ำ (Duration) ตาม NFPA 13:</strong>
                    <ul class="sub-list">
                        <li>Light Hazard: <strong>30 นาที</strong></li>
                        <li>Ordinary Hazard: <strong>60 - 90 นาที</strong></li>
                        <li>Extra Hazard: <strong>90 - 120 นาที</strong></li>
                    </ul>
                 </li>
                 <li>
                     <strong>ตัวอย่าง:</strong> หากระบบเป็น <strong id="example-hazard-name"></strong> ต้องการน้ำ <strong id="example-lpm"></strong> LPM และต้องสำรองน้ำนาน <strong id="example-duration"></strong> นาที จะต้องมีถังเก็บน้ำขนาดอย่างน้อย <strong id="example-tank-size"></strong> ลิตร
                 </li>
             </ul>
             
            <h4>ข้อควรพิจารณาเพิ่มเติม</h4>
            <ul>
                <li><strong>การเลือกขนาดถังจริง:</strong> ค่าที่คำนวณได้คือปริมาตรน้ำขั้นต่ำที่ใช้งานได้ (Net Usable Volume) ในทางปฏิบัติควรเลือกขนาดถังมาตรฐาน (เช่น 50,000 ลิตร, 75,000 ลิตร, 100,000 ลิตร) ที่มีความจุไม่น้อยกว่าค่านี้</li>
                <li><strong>ปริมาตรเผื่อ:</strong> การออกแบบจริงอาจต้องพิจารณาปริมาตรน้ำส่วนที่ไม่สามารถใช้งานได้ (ก้นถัง) และปริมาตรอากาศ (Freeboard) เพิ่มเติม ซึ่งทำให้ขนาดถังโดยรวม (Gross Volume) ใหญ่กว่าค่าที่คำนวณได้</li>
                <li><strong>ข้อบังคับท้องถิ่น:</strong> ควรตรวจสอบข้อกำหนดของหน่วยงานท้องถิ่นซึ่งอาจมีข้อบังคับเกี่ยวกับขนาดถังสำรองน้ำดับเพลิงเพิ่มเติมจากมาตรฐานสากล</li>
            </ul>
        </div>
    </div>
    
    <div id="print-area" style="display: none;">
        <div id="print-header">
            <h1>สรุปผลการคำนวณเบื้องต้นของระบบดับเพลิงด้วยน้ำ</h1>
            <p id="print-date"></p>
        </div>
        <div id="print-inputs-wrapper" class="print-section"></div>
        <div id="print-results-wrapper" class="print-section"></div>
        <div id="print-guidance-wrapper" class="print-section"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- CONFIGURATION ---
            const M_TO_FT = 3.28084;
            const FT_TO_M = 1 / M_TO_FT;
            const GPM_TO_LPM = 3.785; 
            const PSI_TO_BAR = 0.0689476;
            const MIN_SPACING_M = 1.8; // 6 ft
            const MIN_PRESSURE_PSI = 7.0;

            const HAZARD_CONFIG = {
                light: { name: 'Light Hazard', density: 0.10, area: 1500, hose: 100, maxSpacing: 4.6, maxArea: 20.9, duration: 30 },
                ordinary1: { name: 'Ordinary Hazard Group 1', density: 0.15, area: 1500, hose: 250, maxSpacing: 4.6, maxArea: 12.1, duration: 90 },
                ordinary2: { name: 'Ordinary Hazard Group 2', density: 0.20, area: 1500, hose: 250, maxSpacing: 4.6, maxArea: 12.1, duration: 90 },
                extra1: { name: 'Extra Hazard Group 1', density: 0.30, area: 2500, hose: 500, maxSpacing: 3.7, maxArea: 9.3, duration: 120 },
                extra2: { name: 'Extra Hazard Group 2', density: 0.40, area: 2500, hose: 500, maxSpacing: 3.7, maxArea: 9.3, duration: 120 },
            };

            // --- DOM ELEMENTS ---
            const els = {
                hazardType: document.getElementById('hazard_type'),
                density: document.getElementById('density'),
                areaOfOperation: document.getElementById('area_of_operation'),
                spacingS: document.getElementById('spacing_s'),
                spacingL: document.getElementById('spacing_l'),
                spacingSGuidance: document.getElementById('spacing_s_guidance'),
                spacingLGuidance: document.getElementById('spacing_l_guidance'),
                coverageAreaDisplay: document.getElementById('coverage_area_display'),
                areaWarning: document.getElementById('area_warning'),
                hoseDemand: document.getElementById('hose_demand'),
                kFactor: document.getElementById('k_factor'),
                overageFactor: document.getElementById('overage_factor'),
                sprinklerDemandGpm: document.getElementById('sprinkler_demand_gpm'),
                sprinklerDemandLpm: document.getElementById('sprinkler_demand_lpm'),
                totalDemandGpm: document.getElementById('total_demand_gpm'),
                totalDemandLpm: document.getElementById('total_demand_lpm'),
                numSprinklers: document.getElementById('num_sprinklers'),
                numSprinklersRounded: document.getElementById('num_sprinklers_rounded'),
                endHeadFlowGpm: document.getElementById('end_head_flow_gpm'),
                endHeadFlowLpm: document.getElementById('end_head_flow_lpm'),
                endHeadPressurePsi: document.getElementById('end_head_pressure_psi'),
                endHeadPressureBar: document.getElementById('end_head_pressure_bar'),
                pressureWarning: document.getElementById('pressure_warning'),
                pressureOk: document.getElementById('pressure_ok'),
                suggestionBox: document.getElementById('suggestion_box'),
                exportPdfBtn: document.getElementById('exportPdfBtn'),
                exportExcelBtn: document.getElementById('exportExcelBtn')
            };

            // --- FUNCTIONS ---
            function updateHazardDefaults() {
                const hazard = els.hazardType.value;
                const config = HAZARD_CONFIG[hazard];
                if (config) {
                    els.density.value = config.density.toFixed(2);
                    els.areaOfOperation.value = config.area;
                    els.hoseDemand.value = config.hose;
                    updateSpacingGuidance();
                }
                calculateAll();
            }
            
            function mToFt(m) { return m * M_TO_FT; }
            function gpmToLpm(gpm) { return gpm * GPM_TO_LPM; }
            function psiToBar(psi) { return psi * PSI_TO_BAR; }

            function calculateAll() {
                // 1. Get all input values
                const hazard = els.hazardType.value;
                const density = parseFloat(els.density.value) || 0;
                const areaOfOp = parseFloat(els.areaOfOperation.value) || 0;
                const spacingS_m = parseFloat(els.spacingS.value) || 0;
                const spacingL_m = parseFloat(els.spacingL.value) || 0;
                const hose = parseInt(els.hoseDemand.value, 10) || 0;
                const kFactor = parseFloat(els.kFactor.value) || 0;
                const overageFactor = parseFloat(els.overageFactor.value) || 1.0;

                // 2. Intermediate Calculations
                const coverageArea_m2 = spacingS_m * spacingL_m;
                const coverageArea_sqft = mToFt(mToFt(coverageArea_m2));
                
                let numSprinklers = (coverageArea_sqft > 0) ? (areaOfOp / coverageArea_sqft) : 0;
                if (numSprinklers < 1 && areaOfOp > 0) numSprinklers = 1;
                const numSprinklersRounded = Math.ceil(numSprinklers);

                const sprinklerDemandGpm = density * areaOfOp * overageFactor;
                const totalDemandGpm = sprinklerDemandGpm + hose;
                const endHeadFlowGpm = density * coverageArea_sqft;
                const endHeadPressurePsi = kFactor > 0 ? Math.pow(endHeadFlowGpm / kFactor, 2) : 0;
                
                const config = HAZARD_CONFIG[hazard];
                const duration = config ? config.duration : 0;
                const tankSizeLiters = gpmToLpm(totalDemandGpm) * duration;

                // 3. Update UI - Main Results
                els.coverageAreaDisplay.value = `${coverageArea_m2.toFixed(2)} m² / ${coverageArea_sqft.toFixed(2)} sq.ft`;
                els.sprinklerDemandGpm.textContent = `${sprinklerDemandGpm.toFixed(2)} GPM`;
                els.sprinklerDemandLpm.textContent = `(${gpmToLpm(sprinklerDemandGpm).toFixed(2)} LPM)`;
                els.totalDemandGpm.textContent = `${totalDemandGpm.toFixed(2)} GPM`;
                els.totalDemandLpm.textContent = `(${gpmToLpm(totalDemandGpm).toFixed(2)} LPM)`;
                els.numSprinklers.textContent = `${numSprinklers.toFixed(2)}`;
                els.numSprinklersRounded.textContent = `(ปัดขึ้น ${numSprinklersRounded} หัว)`;
                els.endHeadFlowGpm.textContent = `${endHeadFlowGpm.toFixed(2)} GPM`;
                els.endHeadFlowLpm.textContent = `(${gpmToLpm(endHeadFlowGpm).toFixed(2)} LPM)`;
                els.endHeadPressurePsi.textContent = `${endHeadPressurePsi.toFixed(2)} psi`;
                els.endHeadPressureBar.textContent = `(${psiToBar(endHeadPressurePsi).toFixed(2)} bar)`;

                // 4. Update UI - Warnings and Suggestions
                updateAreaWarning(coverageArea_m2);
                updatePressureWarning(endHeadPressurePsi, kFactor, endHeadFlowGpm);
                
                // 5. Update Guidance Section with all dynamic values
                updateGuidanceValues({
                    totalDemandGpm: totalDemandGpm.toFixed(2),
                    endHeadPressurePsi: endHeadPressurePsi.toFixed(2),
                    hazardName: config.name,
                    totalDemandLpm: gpmToLpm(totalDemandGpm).toFixed(2),
                    duration: duration,
                    tankSize: tankSizeLiters.toLocaleString('th-TH', { maximumFractionDigits: 0 })
                });
            }

            function updateSpacingGuidance() {
                const config = HAZARD_CONFIG[els.hazardType.value];
                if (!config) return;
                
                const guidanceText = `(มาตรฐาน: ${MIN_SPACING_M} - ${config.maxSpacing} m)`;
                els.spacingSGuidance.textContent = guidanceText;
                els.spacingLGuidance.textContent = guidanceText;
            }

            function updateAreaWarning(area_m2) {
                const config = HAZARD_CONFIG[els.hazardType.value];
                if (!config) return;

                const maxArea = config.maxArea;
                const maxAreaFt = mToFt(mToFt(maxArea));
                
                if (area_m2 > maxArea) {
                    els.areaWarning.innerHTML = `<strong>คำเตือน:</strong> พื้นที่ครอบคลุมเกินค่าสูงสุดที่กำหนดสำหรับ ${config.name} (${maxArea.toFixed(1)} m² หรือ ~${maxAreaFt.toFixed(0)} sq.ft)`;
                    els.areaWarning.style.display = 'block';
                } else {
                    els.areaWarning.style.display = 'none';
                }
            }
            
            function updatePressureWarning(pressure, k, q) {
                const isLow = pressure < MIN_PRESSURE_PSI && pressure > 0;
                els.pressureWarning.style.display = isLow ? 'block' : 'none';
                els.pressureOk.style.display = pressure >= MIN_PRESSURE_PSI ? 'block' : 'none';
                
                if (isLow && k > 0) {
                    const requiredK = q / Math.sqrt(MIN_PRESSURE_PSI);
                    let suggestionText = `<strong>ข้อเสนอแนะ:</strong> เพื่อให้ได้แรงดันขั้นต่ำ ${MIN_PRESSURE_PSI} psi ควรพิจารณา:<ul>`;
                    suggestionText += `<li>1. เพิ่มค่า K-Factor ให้มากกว่า ${requiredK.toFixed(2)}</li>`;
                    suggestionText += `<li>2. ลดระยะห่างของหัวสปริงเกอร์เพื่อลดอัตราการไหล (q) ที่หัวสุดท้าย</li></ul>`;
                    
                    els.suggestionBox.innerHTML = suggestionText;
                    els.suggestionBox.style.display = 'block';
                } else {
                    els.suggestionBox.style.display = 'none';
                }
            }
            
            function updateGuidanceValues(values) {
                // Section 1: Pump Selection
                document.getElementById('pump-demand-gpm').textContent = values.totalDemandGpm;
                document.getElementById('pump-pressure-psi').textContent = values.endHeadPressurePsi;

                // Section 2: Tank Sizing Example
                document.getElementById('example-hazard-name').textContent = values.hazardName;
                document.getElementById('example-lpm').textContent = values.totalDemandLpm;
                document.getElementById('example-duration').textContent = values.duration;
                document.getElementById('example-tank-size').textContent = values.tankSize;
            }

            function generateCsv() {
                const headers = [
                    "พารามิเตอร์ (Parameter)", "ค่า (Value)", "หน่วย (Unit)",
                    "Parameter (English)", "Value", "Unit"
                ];
                
                const data = [
                    ["ประเภทพื้นที่อันตราย", HAZARD_CONFIG[els.hazardType.value].name, "-", "Hazard Classification", HAZARD_CONFIG[els.hazardType.value].name, "-"],
                    ["ความหนาแน่นการฉีดน้ำ", els.density.value, "gpm/sq.ft", "Density (Ds)", els.density.value, "gpm/sq.ft"],
                    ["พื้นที่ปฏิบัติงาน", els.areaOfOperation.value, "sq.ft", "Area of Operation (Ao)", els.areaOfOperation.value, "sq.ft"],
                    ["ระยะห่างระหว่างหัว (S)", els.spacingS.value, "m", "Spacing (S)", els.spacingS.value, "m"],
                    ["ระยะห่างระหว่างกิ่ง (L)", els.spacingL.value, "m", "Spacing (L)", els.spacingL.value, "m"],
                    ["K-Factor", els.kFactor.value, "-", "K-Factor", els.kFactor.value, "-"],
                    ["น้ำสำรองสายฉีด", els.hoseDemand.value, "gpm", "Hose Demand", els.hoseDemand.value, "gpm"],
                    [],
                    ["ผลการคำนวณ", "Result", "", "Calculation Result", "Result", ""],
                    ["ปริมาณน้ำที่ระบบต้องการ", els.sprinklerDemandGpm.textContent.replace(' GPM', ''), "GPM", "Sprinkler System Demand", els.sprinklerDemandGpm.textContent.replace(' GPM', ''), "GPM"],
                    ["ปริมาณน้ำรวมทั้งระบบ", els.totalDemandGpm.textContent.replace(' GPM', ''), "GPM", "Total Demand", els.totalDemandGpm.textContent.replace(' GPM', ''), "GPM"],
                    ["จำนวนหัวสปริงเกอร์", els.numSprinklersRounded.textContent.replace('(ปัดขึ้น ', '').replace(' หัว)', ''), "หัว", "Number of Sprinklers", els.numSprinklersRounded.textContent.replace('(ปัดขึ้น ', '').replace(' หัว)', ''), "heads"],
                    ["อัตราการไหลที่หัวสุดท้าย", els.endHeadFlowGpm.textContent.replace(' GPM', ''), "GPM", "End-Head Flow", els.endHeadFlowGpm.textContent.replace(' GPM', ''), "GPM"],
                    ["แรงดันเริ่มต้นที่หัวสุดท้าย", els.endHeadPressurePsi.textContent.replace(' psi', ''), "psi", "End-Head Start Pressure", els.endHeadPressurePsi.textContent.replace(' psi', ''), "psi"],
                ];
                
                let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
                csvContent += headers.join(",") + "\r\n";
                data.forEach(rowArray => {
                    let row = rowArray.join(",");
                    csvContent += row + "\r\n";
                });
                
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "fire_protection_calculation.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
            
            function preparePrintContent() {
                document.getElementById('print-date').textContent = `วันที่จัดทำ: ${new Date().toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' })}`;

                const inputsContent = document.getElementById('inputs').querySelector('fieldset').cloneNode(true);
                const resultsContent = document.getElementById('results').querySelector('fieldset').cloneNode(true);
                
                inputsContent.querySelectorAll('.tooltip-icon, .info-box').forEach(el => el.remove());
                resultsContent.querySelectorAll('.pressure-warning, .pressure-ok, .suggestion-box, .export-section').forEach(el => el.remove());
                
                inputsContent.className = 'print-fieldset';
                resultsContent.className = 'print-fieldset';

                const inputsWrapper = document.getElementById('print-inputs-wrapper');
                const resultsWrapper = document.getElementById('print-results-wrapper');
                const guidanceWrapper = document.getElementById('print-guidance-wrapper');
                
                inputsWrapper.innerHTML = '';
                resultsWrapper.innerHTML = '';
                guidanceWrapper.innerHTML = '';

                inputsWrapper.appendChild(inputsContent);
                resultsWrapper.appendChild(resultsContent);

                const guidanceContent = document.getElementById('guidance-section').querySelector('.content').cloneNode(true);
                guidanceWrapper.appendChild(guidanceContent);
            }

            // --- EVENT LISTENERS ---
            els.hazardType.addEventListener('change', updateHazardDefaults);
            [els.density, els.areaOfOperation, els.spacingS, els.spacingL, els.hoseDemand, els.kFactor, els.overageFactor].forEach(el => {
                el.addEventListener('input', calculateAll);
            });
            
            els.exportExcelBtn.addEventListener('click', generateCsv);

            els.exportPdfBtn.addEventListener('click', () => {
                preparePrintContent();
                window.print();
            });

            // --- INITIALIZATION ---
            updateHazardDefaults();
        });
    </script>

</body>
</html>
